<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Transferring‚Ä¶</title>
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: 'Inter', sans-serif;
    }

    .status-container {
      background: rgba(255, 255, 255, 0.95);
      color: #374151;
      padding: 3rem;
      border-radius: 1rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 90%;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .status-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 2rem;
      color: #1f2937;
    }

    .progress-wrapper {
      margin: 2rem 0;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);
      background-size: 200% 100%;
      animation: gradient-shift 2s ease-in-out infinite;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(45deg, 
        transparent 35%, 
        rgba(255, 255, 255, 0.3) 35%, 
        rgba(255, 255, 255, 0.3) 65%, 
        transparent 65%);
      background-size: 25px 25px;
      animation: progress-stripes 1s linear infinite;
    }

    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes progress-stripes {
      0% { background-position: 0 0; }
      100% { background-position: 25px 0; }
    }

    .progress-percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 600;
      font-size: 0.875rem;
      color: #374151;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    }

    .status-message {
      margin-top: 1.5rem;
      font-size: 1rem;
      color: #6b7280;
      line-height: 1.6;
      min-height: 3rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .status-icon {
      display: inline-block;
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }

    .loading-dots {
      display: inline-block;
      margin-left: 0.5rem;
    }

    .loading-dots::after {
      content: '';
      animation: loading-dots 1.5s infinite;
    }

    @keyframes loading-dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    .eta-display {
      margin-top: 1rem;
      font-size: 0.875rem;
      color: #9ca3af;
    }

    .cancel-button {
      margin-top: 2rem;
      background: #ef4444;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .cancel-button:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }

    /* Success state */
    .status-success {
      color: #059669;
    }

    .status-success .progress-fill {
      background: linear-gradient(90deg, #059669, #34d399);
    }

    /* Error state */
    .status-error {
      color: #dc2626;
    }

    .status-error .progress-fill {
      background: linear-gradient(90deg, #dc2626, #f87171);
    }

    /* Mobile responsiveness */
    @media (max-width: 480px) {
      .status-container {
        padding: 2rem 1.5rem;
        margin: 1rem;
      }

      .status-title {
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .progress-bar {
        height: 16px;
      }

      .status-message {
        font-size: 0.9rem;
        min-height: 2.5rem;
      }
    }

    /* Add some sparkle effects */
    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
      animation: sparkle 2s infinite;
    }

    .sparkle:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
    .sparkle:nth-child(2) { top: 80%; left: 80%; animation-delay: 0.5s; }
    .sparkle:nth-child(3) { top: 40%; left: 90%; animation-delay: 1s; }
    .sparkle:nth-child(4) { top: 70%; left: 10%; animation-delay: 1.5s; }

    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="sparkle"></div>
  <div class="sparkle"></div>
  <div class="sparkle"></div>
  <div class="sparkle"></div>

  <div class="status-container">
    <h2 class="status-title">üéµ Transferring Your Playlist</h2>
    
    <div class="progress-wrapper">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
        <div class="progress-percentage" id="progressText">0%</div>
      </div>
    </div>
    
    <div class="status-message" id="statusMessage">
      <span class="status-icon">‚è≥</span>
      <span>Starting transfer<span class="loading-dots"></span></span>
    </div>
    
    <div class="eta-display" id="etaDisplay"></div>
    
    <button class="cancel-button" onclick="cancelTransfer()" style="display: none;" id="cancelBtn">
      Cancel Transfer
    </button>
  </div>

  <script>
    const sessionId = new URLSearchParams(location.search).get('session_id');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const statusMessage = document.getElementById('statusMessage');
    const etaDisplay = document.getElementById('etaDisplay');
    const statusContainer = document.querySelector('.status-container');

    let startTime = Date.now();
    let lastPercent = 0;

    function updateETA(percent) {
      if (percent > 5 && percent < 95) {
        const elapsed = (Date.now() - startTime) / 1000;
        const rate = percent / elapsed;
        const remaining = (100 - percent) / rate;
        const eta = Math.round(remaining);
        
        if (eta > 60) {
          etaDisplay.textContent = `Estimated time: ${Math.round(eta / 60)} min ${eta % 60} sec`;
        } else {
          etaDisplay.textContent = `Estimated time: ${eta} seconds`;
        }
      } else {
        etaDisplay.textContent = '';
      }
    }

    function getStatusIcon(message) {
      if (message.includes('‚úÖ')) return '‚úÖ';
      if (message.includes('‚ùå')) return '‚ùå';
      if (message.includes('Searching')) return 'üîç';
      if (message.includes('Creating')) return 'üéµ';
      if (message.includes('Found')) return '‚ú®';
      return '‚è≥';
    }

    async function checkProgress() {
      try {
        const response = await fetch(`/progress?session_id=${encodeURIComponent(sessionId)}`, { 
          cache: 'no-store' 
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const { percent, message } = await response.json();
        
        // Update progress bar
        progressFill.style.width = `${percent}%`;
        progressText.textContent = `${Math.round(percent)}%`;
        
        // Update status message with icon
        const icon = getStatusIcon(message);
        statusMessage.innerHTML = `<span class="status-icon">${icon}</span><span>${message}</span>`;
        
        // Update ETA
        updateETA(percent);
        
        // Handle completion
        if (percent >= 100) {
          if (message.includes('‚úÖ')) {
            statusContainer.classList.add('status-success');
            setTimeout(() => {
              window.location.href = `/result?session_id=${encodeURIComponent(sessionId)}`;
            }, 2000);
          } else if (message.includes('‚ùå')) {
            statusContainer.classList.add('status-error');
            setTimeout(() => {
              window.location.href = `/result?session_id=${encodeURIComponent(sessionId)}`;
            }, 3000);
          } else {
            setTimeout(() => {
              window.location.href = `/result?session_id=${encodeURIComponent(sessionId)}`;
            }, 1000);
          }
          return;
        }
        
        lastPercent = percent;
      } catch (error) {
        console.error('Progress check failed:', error);
        statusMessage.innerHTML = '<span class="status-icon">‚ö†Ô∏è</span><span>Connection issue, retrying...</span>';
      }
      
      setTimeout(checkProgress, 1000);
    }

    function cancelTransfer() {
      if (confirm('Are you sure you want to cancel the transfer?')) {
        window.location.href = '/transfer';
      }
    }

    // Start progress checking
    checkProgress();
    
    // Show cancel button after 10 seconds
    setTimeout(() => {
      document.getElementById('cancelBtn').style.display = 'block';
    }, 10000);
  </script>
</body>
</html>